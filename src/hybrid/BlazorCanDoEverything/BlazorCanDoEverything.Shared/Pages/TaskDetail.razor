@page "/task/{Id:int}"
@inject ITaskRepository TaskRepository
@inject IProjectRepository ProjectRepository
@inject NavigationManager Navigation

<PageTitle>@(_isNew ? "New Task" : "Task")</PageTitle>

<div class="flex flex-row items-center mb-4">
    <MBButton ButtonStyle="@MBButtonStyle.Text" 
              LeadingIcon="arrow_back"
              @onclick="GoBack">
        Back
    </MBButton>
    <div style="flex: 1;"></div>
    @if (!_isNew)
    {
        <MBButton ButtonStyle="@MBButtonStyle.Outlined" 
                  LeadingIcon="delete"
                  @onclick="DeleteTask">
            Delete
        </MBButton>
    }
</div>

@if (_isLoading)
{
    <MBCircularProgress />
}
else
{
    <div class="flex flex-col gap-4" style="max-width: 600px;">
        <MBTextField @bind-Value="_title" 
                     Label="Task" 
                     Style="width: 100%;" />
        
        <MBCheckbox @bind-Value="_isCompleted" Label="Completed" />

        <MBSelect @bind-Value="_selectedProjectId"
                  Label="Project"
                  Items="@_projectItems"
                  Style="width: 100%;" />

        <MBButton ButtonStyle="@MBButtonStyle.ContainedRaised" 
                  Style="width: 100%;"
                  @onclick="SaveTask">
            Save
        </MBButton>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    
    [SupplyParameterFromQuery(Name = "projectId")]
    public int? ProjectIdFromQuery { get; set; }

    private bool _isLoading = true;
    private bool _isNew => Id == 0;
    private ProjectTask? _task;
    
    private string _title = string.Empty;
    private bool _isCompleted;
    private string _selectedProjectId = "";
    private List<Project> _projects = [];
    private MBSelectElement<string>[] _projectItems = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectRepository.ListAsync();
            _projectItems = _projects.Select(p => new MBSelectElement<string> { SelectedValue = p.ID.ToString(), Label = p.Name }).ToArray();

            if (!_isNew)
            {
                _task = await TaskRepository.GetAsync(Id);
                if (_task != null)
                {
                    _title = _task.Title;
                    _isCompleted = _task.IsCompleted;
                    _selectedProjectId = _task.ProjectID.ToString();
                }
            }
            else if (ProjectIdFromQuery.HasValue)
            {
                _selectedProjectId = ProjectIdFromQuery.Value.ToString();
            }
            else if (_projects.Any())
            {
                _selectedProjectId = _projects.First().ID.ToString();
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveTask()
    {
        var task = _task ?? new ProjectTask();
        task.Title = _title;
        task.IsCompleted = _isCompleted;
        task.ProjectID = int.TryParse(_selectedProjectId, out var projId) ? projId : 0;

        await TaskRepository.SaveItemAsync(task);
        GoBack();
    }

    private async Task DeleteTask()
    {
        if (_task != null)
        {
            await TaskRepository.DeleteItemAsync(_task);
            GoBack();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}
