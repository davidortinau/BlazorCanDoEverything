@page "/manage"
@inject ICategoryRepository CategoryRepository
@inject ITagRepository TagRepository

<PageTitle>Manage Meta</PageTitle>

<h3 style="margin-bottom: 1rem; color: var(--md-sys-color-on-background);">Categories and Tags</h3>

@if (_isLoading)
{
    <MBCircularProgress />
}
else
{
    <h4 style="margin-bottom: 0.5rem; color: var(--md-sys-color-on-background);">Categories</h4>
    
    <div class="flex flex-col gap-2 mb-4">
        @foreach (var category in _categories)
        {
            <div class="card">
                <div class="flex flex-row items-center gap-2">
                    <MBTextField @bind-Value="category.Title" Style="flex: 2;" Label="Name" />
                    <MBTextField @bind-Value="category.Color" Style="flex: 1;" Label="Color" />
                    <div style="width: 30px; height: 30px; background-color: @category.Color; border-radius: 4px;"></div>
                    <MBIconButton Icon="delete" @onclick="@(() => DeleteCategory(category))" />
                </div>
            </div>
        }
    </div>

    <div class="flex flex-row gap-2 mb-4">
        <MBButton ButtonStyle="@MBButtonStyle.ContainedRaised" @onclick="SaveCategories" Style="flex: 1;" Label="Save Categories" />
        <MBButton ButtonStyle="@MBButtonStyle.Outlined" 
                  LeadingIcon="add"
                  @onclick="AddCategory"
                  Label="Add" />
    </div>

    <h4 style="margin-bottom: 0.5rem; color: var(--md-sys-color-on-background);">Tags</h4>
    
    <div class="flex flex-col gap-2 mb-4">
        @foreach (var tag in _tags)
        {
            <div class="card">
                <div class="flex flex-row items-center gap-2">
                    <MBTextField @bind-Value="tag.Title" Style="flex: 2;" Label="Name" />
                    <MBTextField @bind-Value="tag.Color" Style="flex: 1;" Label="Color" />
                    <div style="width: 30px; height: 30px; background-color: @tag.Color; border-radius: 4px;"></div>
                    <MBIconButton Icon="delete" @onclick="@(() => DeleteTag(tag))" />
                </div>
            </div>
        }
    </div>

    <div class="flex flex-row gap-2">
        <MBButton ButtonStyle="@MBButtonStyle.ContainedRaised" @onclick="SaveTags" Style="flex: 1;" Label="Save Tags" />
        <MBButton ButtonStyle="@MBButtonStyle.Outlined" 
                  LeadingIcon="add"
                  @onclick="AddTag"
                  Label="Add" />
    </div>
}

@code {
    private bool _isLoading = true;
    private List<Category> _categories = [];
    private List<Tag> _tags = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _categories = await CategoryRepository.ListAsync();
            _tags = await TagRepository.ListAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void AddCategory()
    {
        _categories.Add(new Category { Title = "New Category", Color = "#808080" });
    }

    private async Task SaveCategories()
    {
        foreach (var category in _categories)
        {
            await CategoryRepository.SaveItemAsync(category);
        }
    }

    private async Task DeleteCategory(Category category)
    {
        if (category.ID > 0)
        {
            await CategoryRepository.DeleteItemAsync(category);
        }
        _categories.Remove(category);
    }

    private void AddTag()
    {
        _tags.Add(new Tag { Title = "New Tag", Color = "#808080" });
    }

    private async Task SaveTags()
    {
        foreach (var tag in _tags)
        {
            await TagRepository.SaveItemAsync(tag);
        }
    }

    private async Task DeleteTag(Tag tag)
    {
        if (tag.ID > 0)
        {
            await TagRepository.DeleteItemAsync(tag);
        }
        _tags.Remove(tag);
    }
}
