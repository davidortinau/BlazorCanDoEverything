@page "/project/{Id:int}"
@inject IProjectRepository ProjectRepository
@inject ITaskRepository TaskRepository
@inject ICategoryRepository CategoryRepository
@inject ITagRepository TagRepository
@inject NavigationManager Navigation

<PageTitle>@(_isNew ? "New Project" : "Project")</PageTitle>

<div class="flex flex-row items-center mb-4">
    <MBButton ButtonStyle="@MBButtonStyle.Text" 
              LeadingIcon="arrow_back"
              @onclick="GoBack">
        Back
    </MBButton>
    <div style="flex: 1;"></div>
    @if (!_isNew)
    {
        <MBButton ButtonStyle="@MBButtonStyle.Outlined" 
                  LeadingIcon="delete"
                  @onclick="DeleteProject">
            Delete
        </MBButton>
    }
</div>

@if (_isLoading)
{
    <MBCircularProgress />
}
else
{
    <div class="flex flex-col gap-4" style="max-width: 600px;">
        <MBTextField @bind-Value="_name" 
                     Label="Name" 
                     Style="width: 100%;" />
        
        <MBTextField @bind-Value="_description" 
                     Label="Description" 
                     Style="width: 100%;" />

        <MBSelect @bind-Value="_selectedCategoryId"
                  Label="Category"
                  Items="@_categoryItems"
                  Style="width: 100%;" />

        <h5 style="margin: 0;">Tags</h5>
        <div class="flex flex-row flex-wrap gap-2">
            @foreach (var tag in _allTags)
            {
                <TagChip Tag="@tag" 
                         IsSelected="@_selectedTagIds.Contains(tag.ID)"
                         OnClick="ToggleTag" />
            }
        </div>

        <MBButton ButtonStyle="@MBButtonStyle.ContainedRaised" 
                  Style="width: 100%;"
                  @onclick="SaveProject">
            Save
        </MBButton>

        @if (!_isNew)
        {
            <div class="flex flex-row items-center">
                <h5 style="margin: 0;">Tasks</h5>
                <div style="flex: 1;"></div>
                @if (_tasks.Any(t => t.IsCompleted))
                {
                    <MBButton ButtonStyle="@MBButtonStyle.Text" 
                              LeadingIcon="delete"
                              @onclick="CleanCompletedTasks">
                        Clean up
                    </MBButton>
                }
            </div>

            <div class="flex flex-col gap-2">
                @foreach (var task in _tasks)
                {
                    <TaskView Task="@task" 
                              OnCompleted="OnTaskCompleted" 
                              OnClick="NavigateToTask" />
                }
            </div>
        }
    </div>
}

@if (!_isNew)
{
    <AddButton Title="Add Task" OnClick="@(() => Navigation.NavigateTo($"/task/0?projectId={Id}"))" />
}

@code {
    [Parameter] public int Id { get; set; }

    private bool _isLoading = true;
    private bool _isNew => Id == 0;
    private Project? _project;
    
    private string _name = string.Empty;
    private string _description = string.Empty;
    private string _selectedCategoryId = "";
    private List<Category> _categories = [];
    private MBSelectElement<string>[] _categoryItems = [];
    private List<Tag> _allTags = [];
    private HashSet<int> _selectedTagIds = [];
    private List<ProjectTask> _tasks = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _categories = await CategoryRepository.ListAsync();
            _categoryItems = _categories.Select(c => new MBSelectElement<string> { SelectedValue = c.ID.ToString(), Label = c.Title }).ToArray();
            _allTags = await TagRepository.ListAsync();

            if (!_isNew)
            {
                _project = await ProjectRepository.GetAsync(Id);
                if (_project != null)
                {
                    _name = _project.Name;
                    _description = _project.Description;
                    _selectedCategoryId = _project.CategoryID.ToString();
                    _selectedTagIds = _project.Tags?.Select(t => t.ID).ToHashSet() ?? [];
                    _tasks = _project.Tasks ?? [];
                }
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ToggleTag(Tag tag)
    {
        if (_selectedTagIds.Contains(tag.ID))
        {
            _selectedTagIds.Remove(tag.ID);
        }
        else
        {
            _selectedTagIds.Add(tag.ID);
        }
    }

    private async Task SaveProject()
    {
        var project = _project ?? new Project();
        project.Name = _name;
        project.Description = _description;
        project.CategoryID = int.TryParse(_selectedCategoryId, out var catId) ? catId : 0;

        await ProjectRepository.SaveItemAsync(project);

        // Save tag associations
        foreach (var tagId in _selectedTagIds)
        {
            var tag = _allTags.First(t => t.ID == tagId);
            await TagRepository.SaveItemAsync(tag, project.ID);
        }

        Navigation.NavigateTo("/projects");
    }

    private async Task DeleteProject()
    {
        if (_project != null)
        {
            await ProjectRepository.DeleteItemAsync(_project);
            Navigation.NavigateTo("/projects");
        }
    }

    private async Task OnTaskCompleted(ProjectTask task)
    {
        await TaskRepository.SaveItemAsync(task);
        StateHasChanged();
    }

    private void NavigateToTask(ProjectTask task)
    {
        Navigation.NavigateTo($"/task/{task.ID}");
    }

    private async Task CleanCompletedTasks()
    {
        var completedTasks = _tasks.Where(t => t.IsCompleted).ToList();
        foreach (var task in completedTasks)
        {
            await TaskRepository.DeleteItemAsync(task);
            _tasks.Remove(task);
        }
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/projects");
    }
}
