@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject BlazorCanDoEverything.Shared.Services.IFormFactor FormFactor

<div class="app-layout @(_isDarkMode ? "dark-theme" : "") @(_isMobile ? "mobile-layout" : "")" data-theme="@(_isDarkMode ? "dark" : "light")">
    <header class="app-header">
        <span class="material-icons">task_alt</span>
        <h1>Todo App</h1>
        <div style="flex: 1;"></div>
        <MBIconButton Icon="@(_isDarkMode ? "light_mode" : "dark_mode")" @onclick="ToggleTheme" />
    </header>

    <div class="app-main">
        @if (!_isMobile)
        {
            <NavMenu />
        }
        <main class="app-content">
            @Body
        </main>
    </div>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _isDarkMode = false;
    private bool _isMobile = false;

    protected override void OnInitialized()
    {
        _isMobile = FormFactor.IsMobile();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var storedTheme = await JS.InvokeAsync<string>("localStorage.getItem", "todo-app-theme");
            if (!string.IsNullOrEmpty(storedTheme))
            {
                _isDarkMode = storedTheme == "dark";
                StateHasChanged();
            }
        }
    }

    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        await JS.InvokeVoidAsync("localStorage.setItem", "todo-app-theme", _isDarkMode ? "dark" : "light");
    }
}